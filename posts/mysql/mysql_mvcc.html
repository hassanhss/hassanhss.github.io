<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL多版本并发控制(MVCC) | hassan</title>
    <meta name="description" content="多版本并发控制">
    <link rel="stylesheet" href="/assets/style.dd5de40c.css">
    <link rel="modulepreload" href="/assets/app.fa80e2f7.js">
    <link rel="modulepreload" href="/assets/posts_mysql_mysql_mvcc.md.6a7d34e3.lean.js">
    
    <meta name="twitter:title" content="MySQL多版本并发控制(MVCC) | hassan">
  <meta property="og:title" content="MySQL多版本并发控制(MVCC) | hassan">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><div class="theme"><header class="nav-bar" data-v-40587210><div class="sidebar-button" data-v-40587210><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="hassan, back to home" data-v-40587210 data-v-016a8bd8><!----> hassan</a><div class="flex-grow" data-v-40587210></div><div class="nav" data-v-40587210><nav class="nav-links" data-v-40587210 data-v-35b91e7e><!--[--><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/" data-v-49fe041d>Home <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/archives" data-v-49fe041d>Archives <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/tags" data-v-49fe041d>Tags <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/about" data-v-49fe041d>About <!----></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-17c48e2f><nav class="nav-links nav" data-v-17c48e2f data-v-35b91e7e><!--[--><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/" data-v-49fe041d>Home <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/archives" data-v-49fe041d>Archives <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/tags" data-v-49fe041d>Tags <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/about" data-v-49fe041d>About <!----></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-17c48e2f><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#事务隔离级别">事务隔离级别</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#事务并发执行遇到的问题">事务并发执行遇到的问题</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#sql标准中的四种隔离级别">SQL标准中的四种隔离级别</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#mysql中支持的四种隔离级别">MySQL中支持的四种隔离级别</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#设置事务的隔离级别">设置事务的隔离级别</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#mvcc原理">MVCC原理</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#版本链">版本链</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#readview">ReadView</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-8fcebc32><div class="container" data-v-8fcebc32><!--[--><!--]--><div style="position:relative;" class="content" data-v-8fcebc32><div><h1 id="多版本并发控制" tabindex="-1">多版本并发控制 <a class="header-anchor" href="#多版本并发控制" aria-hidden="true">#</a></h1><h2 id="事务隔离级别" tabindex="-1">事务隔离级别 <a class="header-anchor" href="#事务隔离级别" aria-hidden="true">#</a></h2><p>MySQL是一个客户端／服务器架构的软件，对于同一个服务器来说，可以有若干个客户端与之连接，每个客户端与服务器连接上之后，就可以称之为一个会话（Session）。每个客户端都可以在自己的会话中向服务器发出请求语句，一个请求语句可能是某个事务的一部分，也就是对于服务器来说可能同时处理多个事务。在事务简介的中我们说过事务有一个称之为隔离性的特性，理论上在某个事务对某个数据进行访问时，其他事务应该进行排队，当该事务提交之后，其他事务才可以继续访问这个数据。但是这样子的话对性能影响太大，我们既想保持事务的隔离性，又想让服务器在处理访问同一数据的多个事务时性能尽量高些，鱼和熊掌不可得兼，舍一部分隔离性而取性能者也。</p><h2 id="事务并发执行遇到的问题" tabindex="-1">事务并发执行遇到的问题 <a class="header-anchor" href="#事务并发执行遇到的问题" aria-hidden="true">#</a></h2><p>我们先得看一下访问相同数据的事务在不保证串行执行（也就是执行完一个再执行另一个）的情况下可能会出现哪些问题：</p><ul><li><p>脏写（Dirty Write） 如果一个事务修改了另一个未提交事务修改过的数据，那就意味着发生了脏写，示意图如下： <img src="/assets/dirty_write.ad4e69cc.png" alt=""> 如上图，Session A和Session B各开启了一个事务，Session B中的事务先将number列为1的记录的name列更新为&#39;关羽&#39;，然后Session A中的事务接着又把这条number列为1的记录的name列更新为张飞。如果之后Session B中的事务进行了回滚，那么Session A中的更新也将不复存在，这种现象就称之为脏写。这时Session A中的事务就很懵逼，我明明把数据更新了，最后也提交事务了，怎么到最后说自己啥也没干呢？</p></li><li><p>脏读（Dirty Read） 如果一个事务读到了另一个未提交事务修改过的数据，那就意味着发生了脏读，示意图如下： <img src="/assets/dirty_read.28e69685.png" alt=""> 如上图，Session A和Session B各开启了一个事务，Session B中的事务先将number列为1的记录的name列更新为&#39;关羽&#39;，然后Session A中的事务再去查询这条number为1的记录，如果读到列name的值为&#39;关羽&#39;，而Session B中的事务稍后进行了回滚，那么Session A中的事务相当于读到了一个不存在的数据，这种现象就称之为脏读。</p></li><li><p>不可重复读（Non-Repeatable Read） 如果一个事务只能读到另一个已经提交的事务修改过的数据，并且其他事务每对该数据进行一次修改并提交后，该事务都能查询得到最新值，那就意味着发生了不可重复读，示意图如下： <img src="/assets/nrepeat_read.360e9170.png" alt=""> 如上图，我们在Session B中提交了几个隐式事务（注意是隐式事务，意味着语句结束事务就提交了），这些事务都修改了number列为1的记录的列name的值，每次事务提交之后，如果Session A中的事务都可以查看到最新的值，这种现象也被称之为不可重复读。</p></li><li><p>幻读（Phantom） 如果一个事务先根据某些条件查询出一些记录，之后另一个事务又向表中插入了符合这些条件的记录，原先的事务再次按照该条件查询时，能把另一个事务插入的记录也读出来，那就意味着发生了幻读，示意图如下： <img src="/assets/phantom.62267e70.png" alt=""> 如上图，Session A中的事务先根据条件number &gt; 0这个条件查询表hero，得到了name列值为&#39;刘备&#39;的记录；之后Session B中提交了一个隐式事务，该事务向表hero中插入了一条新记录；之后Session A中的事务再根据相同的条件number &gt; 0查询表hero，得到的结果集中包含Session B中的事务新插入的那条记录，这种现象也被称之为幻读。</p><p>这里会有疑问，那如果Session B中是删除了一些符合number &gt; 0的记录而不是插入新记录，那Session A中之后再根据number &gt; 0的条件读取的记录变少了，这种现象算不算幻读呢？明确说一下，这种现象不属于幻读，幻读强调的是一个事务按照某个相同条件多次读取记录时，后读取时读到了之前没有读到的记录。</p><blockquote><p>那对于先前已经读到的记录，之后又读取不到这种情况，算啥呢？其实这相当于对每一条记录都发生了不可重复读的现象。幻读只是重点强调了读取到了之前读取没有获取到的记录。</p></blockquote></li></ul><h2 id="sql标准中的四种隔离级别" tabindex="-1">SQL标准中的四种隔离级别 <a class="header-anchor" href="#sql标准中的四种隔离级别" aria-hidden="true">#</a></h2><p>上边介绍了几种并发事务执行过程中可能遇到的一些问题，这些问题也有轻重缓急之分，我们给这些问题按照严重性来排一下序：</p><div class="language-"><pre><code>脏写 &gt; 脏读 &gt; 不可重复读 &gt; 幻读
</code></pre></div><p>上边所说的舍弃一部分隔离性来换取一部分性能在这里就体现在：设立一些隔离级别，隔离级别越低，越严重的问题就越可能发生。在SQL标准中设立了4个隔离级别：</p><ul><li>READ UNCOMMITTED：未提交读。</li><li>READ COMMITTED：已提交读。</li><li>REPEATABLE READ：可重复读。</li><li>SERIALIZABLE：可串行化。</li></ul><p>SQL标准中规定，针对不同的隔离级别，并发事务可以发生不同严重程度的问题，具体情况如下：</p><table><thead><tr><th style="text-align:center;">隔离级别</th><th style="text-align:center;">脏读</th><th style="text-align:center;">不可重复读</th><th style="text-align:center;">幻读</th></tr></thead><tbody><tr><td style="text-align:center;">READ UNCOMMITTED</td><td style="text-align:center;">Possible</td><td style="text-align:center;">Possible</td><td style="text-align:center;">Possible</td></tr><tr><td style="text-align:center;">READ COMMITTED</td><td style="text-align:center;">Not Possible</td><td style="text-align:center;">Possible</td><td style="text-align:center;">Possible</td></tr><tr><td style="text-align:center;">REPEATABLE READ</td><td style="text-align:center;">Not Possible</td><td style="text-align:center;">Not Possible</td><td style="text-align:center;">Possible</td></tr><tr><td style="text-align:center;">SERIALIZABLE</td><td style="text-align:center;">Not Possible</td><td style="text-align:center;">Not Possible</td><td style="text-align:center;">Not Possible</td></tr></tbody></table><h2 id="mysql中支持的四种隔离级别" tabindex="-1">MySQL中支持的四种隔离级别 <a class="header-anchor" href="#mysql中支持的四种隔离级别" aria-hidden="true">#</a></h2><p>不同的数据库厂商对SQL标准中规定的四种隔离级别支持不一样，比方说Oracle就只支持READ COMMITTED和SERIALIZABLE隔离级别。MySQL虽然支持4种隔离级别，但与SQL标准中所规定的各级隔离级别允许发生的问题却有些出入，MySQL在REPEATABLE READ隔离级别下，是可以禁止幻读问题的发生的。</p><p>MySQL的默认隔离级别为REPEATABLE READ。</p><h2 id="设置事务的隔离级别" tabindex="-1">设置事务的隔离级别 <a class="header-anchor" href="#设置事务的隔离级别" aria-hidden="true">#</a></h2><p>我们可以通过下边的语句修改事务的隔离级别：</p><div class="language-"><pre><code>SET [GLOBAL|SESSION] TRANSACTION ISOLATION LEVEL level;
</code></pre></div><p>其中的level可选值有4个：</p><div class="language-"><pre><code>level: {
     REPEATABLE READ
   | READ COMMITTED
   | READ UNCOMMITTED
   | SERIALIZABLE
}
</code></pre></div><h2 id="mvcc原理" tabindex="-1">MVCC原理 <a class="header-anchor" href="#mvcc原理" aria-hidden="true">#</a></h2><h3 id="版本链" tabindex="-1">版本链 <a class="header-anchor" href="#版本链" aria-hidden="true">#</a></h3><p>对于使用InnoDB存储引擎的表来说，它的聚簇索引记录中都包含两个必要的隐藏列（row_id并不是必要的，如果创建的表中有主键或者非NULL的UNIQUE键时都不会包含row_id列）：</p><ul><li>trx_id：每次一个事务对某条聚簇索引记录进行改动时，都会把该事务的事务id赋值给trx_id隐藏列。</li><li>roll_pointer：每次对某条聚簇索引记录进行改动时，都会把旧的版本写入到undo日志中，然后这个隐藏列就相当于一个指针，可以通过它来找到该记录修改前的信息。</li></ul><p>比如我们在表hero中只包含一条记录：</p><div class="language-"><pre><code>mysql&gt; SELECT * FROM hero;
+--------+--------+---------+
| number | name   | country |
+--------+--------+---------+
|      1 | 刘备   | 蜀      |
+--------+--------+---------+
1 row in set (0.07 sec)
</code></pre></div><p>假设插入该记录的事务id为80，那么此刻该条记录的示意图如下所示： <img src="/assets/insert_undo.db9e1dd5.png" alt=""></p><blockquote><p>insert undo 只在事务回滚时起作用，当事务提交后，该类型的undo日志就没用了，它占用的Undo Log Segment也会被系统回收(也就是该undo日志占用的Undo页面链表要么被重用，要么被释放)。虽然真正的insert undo日志占用的存储空间被释放了，但是roll_pointer的值不会被清除，roll_pointer的属性占用7个字节，第一个比特位就标记它指向的undo日志的类型，如果该比特位值为1时，就代表它指向的undo日志类型为insert undo。</p></blockquote><p>假设之后两个事务id分别为100、200的事务对这条记录进行UPDATE操作，操作流程如下： <img src="/assets/mvcc_update.719fda4f.png" alt=""> 每次对记录进行改动，都会记录一条undo日志，每条undo日志也都有一个roll_pointer属性(INSERT 对应的undo日志没有该属性，因为该记录没有更早的版本)，可以将这些undo日志都连起来，串成一个链表，现在hero的表情况如下图所示： <img src="/assets/undo_chain.35334c09.png" alt=""> 对该记录每次更新后，都会将旧值放到一条undo日志中，就算是该记录的一个旧版本，随着更新次数的增多，所有的版本都会被roll_pointer属性连接成一个链表，我们把这个链表称之为版本链，版本链的头节点就是当前记录最新的值。另外，每个版本中还包含生成该版本时对应的事务id。</p><h3 id="readview" tabindex="-1">ReadView <a class="header-anchor" href="#readview" aria-hidden="true">#</a></h3><p>对于使用 READ UNCOMMITTED隔离级别的事务来说，由于可以读到未提交事务修改过的记录，所以直接读取记录的最新版本就可以，对于使用SERIALIZABLE隔离级别的事务来说，InnoDB规定使用加锁的方式来访问记录，对于使用READ COMMITTED和REPEATABLE READ隔离级别的事务来说，都必须保证读到已经提交了的事务修改过的记录，也就是说假如另一个事务已经修改了记录但是尚未提交，是不能直接读取最新版本的记录的，核心问题就是：需要判断一下版本链中的哪个版本是当前事务可见的。为此，InnoDB的提出了一个ReadView的概念，这个ReadView中主要包含4个比较重要的内容：</p><ul><li>m_ids：表示在生成ReadView时，当前系统中活跃的读写事务id列表。</li><li>min_trx_id：表示生成ReadView时，当前系统中活跃的读写事务中最小的事务id，也就是m_ids中最小的值。</li><li>max_trx_id：表示生成ReadView时，系统中应该分配给下一个事务的id值。</li></ul><blockquote><p>注意max_trx_id并不是m_ids中的最大值，事务id是递增分配的。比方说现在有id为1，2，3这三个事务，之后id为3的事务提交了。那么一个新的读事务在生成ReadView时，m_ids就包括1和2，min_trx_id的值就是1，max_trx_id的值就是4。</p></blockquote><ul><li>creator_trx_id：表示生成该ReadView的事务的事务id。</li></ul><blockquote><p>只有在对表中的记录做改动时（执行INSERT、DELETE、UPDATE这些语句时）才会为事务分配事务id，否则在一个只读事务中的事务id值都默认为0。</p></blockquote></div></div><footer class="page-footer" data-v-8fcebc32 data-v-b65b4b36><div class="edit" data-v-b65b4b36><div class="edit-link" data-v-b65b4b36 data-v-55695e90><!----></div></div><div class="updated" data-v-b65b4b36><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--><div class="site-footer"> Copyright © 2021-present <a class="vitepress">hassan</a><br> Powered by <a class="vitepress" target="_blank" href="//vitepress.vuejs.org/">VitePress</a></div><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"1650c883\",\"page_2.md\":\"eaedb893\",\"page_3.md\":\"01eaab37\",\"page_4.md\":\"2219d2db\",\"page_5.md\":\"f4e65ab7\",\"page_6.md\":\"10b6ff1b\",\"pages_about.md\":\"12df84f1\",\"pages_archives.md\":\"72d8819a\",\"pages_tags.md\":\"cf1717d9\",\"posts_blog_github-action.md\":\"b2c03cd9\",\"posts_blog_vitepress-github.md\":\"f81f073b\",\"posts_contract_abi.md\":\"89607447\",\"posts_contract_abstract_interface.md\":\"b629c114\",\"posts_contract_call.md\":\"8d03bc6a\",\"posts_contract_call_contract.md\":\"c2e9c36c\",\"posts_contract_constructor_modifer.md\":\"dc62359a\",\"posts_contract_create.md\":\"5438c523\",\"posts_contract_data_reference.md\":\"b0c7e039\",\"posts_contract_data_storage.md\":\"eb09360a\",\"posts_contract_delegatecall.md\":\"a6be403b\",\"posts_contract_event.md\":\"d58b4217\",\"posts_contract_exception.md\":\"c72b3b2f\",\"posts_contract_fun_overloading.md\":\"f579f744\",\"posts_contract_fun_return_val.md\":\"04f8a7cb\",\"posts_contract_fun_type.md\":\"c773ee14\",\"posts_contract_import.md\":\"3d31626a\",\"posts_contract_inheritance.md\":\"924fe271\",\"posts_contract_library.md\":\"b938a1f0\",\"posts_contract_mapping.md\":\"f9b98232\",\"posts_contract_receive_eth.md\":\"fcbcc7e8\",\"posts_contract_selector.md\":\"67c8b202\",\"posts_contract_send_eth.md\":\"390f7c25\",\"posts_contract_value_type.md\":\"eceb8bcf\",\"posts_docker_accelerator.md\":\"f155fd3a\",\"posts_es_elasticsearch.md\":\"0ec16488\",\"posts_es_es_base_concept.md\":\"c0f1adf1\",\"posts_es_es_dsl_one.md\":\"bbbb9d0d\",\"posts_es_es_dsl_query.md\":\"57d7377b\",\"posts_es_es_dsl_three.md\":\"12d7ddde\",\"posts_es_es_dsl_two.md\":\"75673c50\",\"posts_es_es_index.md\":\"a32dbb1f\",\"posts_es_es_query_agg.md\":\"e7aecb92\",\"posts_es_es_type.md\":\"e0ba3331\",\"posts_front_cors.md\":\"cac4f45b\",\"posts_git_git-learn.md\":\"394d8e0d\",\"posts_java_1.md\":\"29862e49\",\"posts_java_base_java_lang.md\":\"e93f9bec\",\"posts_linux_linux_fork.md\":\"00b2704c\",\"posts_linux_linux_pipe.md\":\"a0d835d3\",\"posts_linux_linux_recv.md\":\"26896bf0\",\"posts_mysql_groupby_orderby.md\":\"647f6014\",\"posts_mysql_mysql_lock_one.md\":\"efe2fab1\",\"posts_mysql_mysql_mvcc.md\":\"6a7d34e3\",\"posts_mysql_mysql_partition.md\":\"3b3002cc\",\"posts_mysql_mysql_transaction.md\":\"3a9f7429\",\"posts_network_tcp-model.md\":\"0fd82ebc\",\"posts_network_tcp-three-shark.md\":\"d4ff6f42\",\"posts_network_tcp-time_wait.md\":\"f9d27211\",\"posts_network_tpcip-one.md\":\"855cb7d6\",\"posts_personal_information.md\":\"e3484297\",\"posts_personal_study.md\":\"1b41d9dc\",\"posts_personal_think-habit.md\":\"1b92f10a\",\"posts_personal_think-object.md\":\"2714719a\",\"posts_personal_work-five.md\":\"f6fe9da8\",\"posts_tools_parallel-centos.md\":\"1920f38a\"}")</script>
    <script type="module" async src="/assets/app.fa80e2f7.js"></script>
    
  </body>
</html>