<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL事务 | hassan</title>
    <meta name="description" content="事务相关问题">
    <link rel="stylesheet" href="/assets/style.dd5de40c.css">
    <link rel="modulepreload" href="/assets/app.a5662684.js">
    <link rel="modulepreload" href="/assets/posts_mysql_mysql_transaction.md.814564e1.lean.js">
    
    <meta name="twitter:title" content="MySQL事务 | hassan">
  <meta property="og:title" content="MySQL事务 | hassan">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><div class="theme"><header class="nav-bar" data-v-40587210><div class="sidebar-button" data-v-40587210><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="hassan, back to home" data-v-40587210 data-v-016a8bd8><!----> hassan</a><div class="flex-grow" data-v-40587210></div><div class="nav" data-v-40587210><nav class="nav-links" data-v-40587210 data-v-35b91e7e><!--[--><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/" data-v-49fe041d>Home <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/archives" data-v-49fe041d>Archives <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/tags" data-v-49fe041d>Tags <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/about" data-v-49fe041d>About <!----></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-17c48e2f><nav class="nav-links nav" data-v-17c48e2f data-v-35b91e7e><!--[--><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/" data-v-49fe041d>Home <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/archives" data-v-49fe041d>Archives <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/tags" data-v-49fe041d>Tags <!----></a></div></div><div class="item" data-v-35b91e7e><div class="nav-link" data-v-35b91e7e data-v-49fe041d><a class="item" href="/pages/about" data-v-49fe041d>About <!----></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-17c48e2f><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#事务的属性">事务的属性</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#mysql中事务的语法">MySQL中事务的语法</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#开启事务">开启事务</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#提交事务">提交事务</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#手动中止事务">手动中止事务</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#自动提交">自动提交</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#保存点">保存点</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#参考">参考</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-8fcebc32><div class="container" data-v-8fcebc32><!--[--><!--]--><div style="position:relative;" class="content" data-v-8fcebc32><div><h1 id="什么是事务？" tabindex="-1">什么是事务？ <a class="header-anchor" href="#什么是事务？" aria-hidden="true">#</a></h1><blockquote><p>A database transaction symbolizes a unit of work, performed within a database management system (or similar system) against a database, that is treated in a coherent and reliable way independent of other transactions. A transaction generally represents any change in a database. Transactions in a database environment have two main purposes:</p></blockquote><blockquote><ol><li>To provide reliable units of work that allow correct recovery from failures and keep a database consistent even in cases of system failure. For example: when execution prematurely and unexpectedly stops (completely or partially) in which case many operations upon a database remain uncompleted, with unclear status.</li></ol></blockquote><blockquote><ol start="2"><li>To provide isolation between programs accessing a database concurrently. If this isolation is not provided, the programs&#39; outcomes are possibly erroneous.</li></ol></blockquote><p>以上是wiki百科中的解释。事务就是保证无论发生什么，数据库中的数据都是处于合理的状态。</p><h2 id="事务的属性" tabindex="-1">事务的属性 <a class="header-anchor" href="#事务的属性" aria-hidden="true">#</a></h2><ul><li><p>Atomicity(原子性)，Transactions are often composed of multiple statements. Atomicity guarantees that each transaction is treated as a single &quot;unit&quot;, which either succeeds completely or fails completely: if any of the statements constituting a transaction fails to complete, the entire transaction fails and the database is left unchanged. An atomic system must guarantee atomicity in each and every situation, including power failures, errors, and crashes. A guarantee of atomicity prevents updates to the database from occurring only partially, which can cause greater problems than rejecting the whole series outright. As a consequence, the transaction cannot be observed to be in progress by another database client. At one moment in time, it has not yet happened, and at the next, it has already occurred in whole (or nothing happened if the transaction was canceled in progress).</p></li><li><p>Consistency(一致性)，Consistency ensures that a transaction can only bring the database from one consistent state to another, preserving database invariants: any data written to the database must be valid according to all defined rules, including constraints, cascades, triggers, and any combination thereof. This prevents database corruption by an illegal transaction. Referential integrity guarantees the primary key–foreign key relationship.</p></li><li><p>Isolation(隔离性)，Transactions are often executed concurrently (e.g., multiple transactions reading and writing to a table at the same time). Isolation ensures that concurrent execution of transactions leaves the database in the same state that would have been obtained if the transactions were executed sequentially. Isolation is the main goal of concurrency control; depending on the isolation level used, the effects of an incomplete transaction might not be visible to other transactions.</p></li><li><p>Durability(持久性)，Durability guarantees that once a transaction has been committed, it will remain committed even in the case of a system failure (e.g., power outage or crash). This usually means that completed transactions (or their effects) are recorded in non-volatile memory.</p></li></ul><p>事务是一个很抽象的概念，它对应着数据库的一个或多个操作，这些操作所执行的不同阶段把事务大致上换分成了这么几个状态：</p><ul><li><p>活动的(active)</p><p>事务对应的数据库操作正在执行过程中时，我们就说该事务处在活动的状态。</p></li><li><p>部分提交的(partially commited)</p><p>当事务中的最后一个操作执行完成，但由于操作都是在内存中执行，所造成的影响并没有刷新到磁盘时，我们就说该事务处在部门提交的状态。</p></li><li><p>失败的(failed)</p><p>当事务处在活动的或者部分提交的状态时，可能遇到了某些错误（数据库自身的错误、操作系统错误或者直接断电等）而无法继续执行，或者人为的停止当前事务的执行，我们就说该事务处在失败的状态。</p></li><li><p>中止的(aborted)</p><p>如果事务执行了半截而变为失败的状态,要撤销失败事务对当前数据库造成的影响。我们把这个撤销的过程称之为回滚。当回滚操作执行完毕时，也就是数据库恢复到了执行事务之前的状态，我们就说该事务处在了中止的状态。</p></li><li><p>提交的(committed)</p><p>当一个处在部分提交的状态的事务将修改过的数据都同步到磁盘上之后，我们就可以说该事务处在了提交的状态。</p></li></ul><p>随着事务对应的数据库操作执行到不同阶段，事务的状态也在不断变化，一个基本的状态转换图如下所示：</p><p><img src="/assets/trx_status.78892190.png" alt=""></p><h2 id="mysql中事务的语法" tabindex="-1">MySQL中事务的语法 <a class="header-anchor" href="#mysql中事务的语法" aria-hidden="true">#</a></h2><h3 id="开启事务" tabindex="-1">开启事务 <a class="header-anchor" href="#开启事务" aria-hidden="true">#</a></h3><p>我们可以使用下边两种语句之一来开启一个事务：</p><ul><li><p>BEGIN [WORK];</p><p>BEGIN语句代表开启一个事务，后边的单词WORK可有可无。开启事务后，就可以继续写若干条语句，这些语句都属于刚刚开启的这个事务。</p><div class="language-"><pre><code>mysql&gt; BEGIN;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; 加入事务的语句...
</code></pre></div></li><li><p>START TRANSACTION;</p><p>START TRANSACTION语句和BEGIN语句有着相同的功效，都标志着开启一个事务，比如这样：</p><div class="language-"><pre><code>mysql&gt; START TRANSACTION;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; 加入事务的语句...
</code></pre></div></li></ul><p>不过比BEGIN语句牛逼一点儿的是，可以在START TRANSACTION语句后边跟随几个修饰符，就是它们几个：</p><ul><li>READ ONLY：标识当前事务是一个只读事务，也就是属于该事务的数据库操作只能读取数据，而不能修改数据。</li><li>READ WRITE：标识当前事务是一个读写事务，也就是属于该事务的数据库操作既可以读取数据，也可以修改数据。</li><li>WITH CONSISTENT SNAPSHOT：启动一致性读</li></ul><p>比如我们想开启一个只读事务的话，直接把READ ONLY这个修饰符加在START TRANSACTION语句后边就好，比如这样：</p><div class="language-"><pre><code>START TRANSACTION READ ONLY;
</code></pre></div><p>如果我们想在START TRANSACTION后边跟随多个修饰符的话，可以使用逗号将修饰符分开，比如开启一个只读事务和一致性读，就可以这样写：</p><div class="language-"><pre><code>START TRANSACTION READ ONLY, WITH CONSISTENT SNAPSHOT;
</code></pre></div><p>或者开启一个读写事务和一致性读，就可以这样写：</p><div class="language-"><pre><code>START TRANSACTION READ WRITE, WITH CONSISTENT SNAPSHOT
</code></pre></div><p>不过这里需要大家注意的一点是，READ ONLY和READ WRITE是用来设置所谓的事务访问模式的，就是以只读还是读写的方式来访问数据库中的数据，一个事务的访问模式不能同时既设置为只读的也设置为读写的，所以我们不能同时把READ ONLY和READ WRITE放到START TRANSACTION语句后边。另外，如果我们不显式指定事务的访问模式，那么该事务的访问模式就是读写模式。</p><h3 id="提交事务" tabindex="-1">提交事务 <a class="header-anchor" href="#提交事务" aria-hidden="true">#</a></h3><p>开启事务之后就可以继续写需要放到该事务中的语句了，当最后一条语句写完了之后，我们就可以提交该事务了，提交的语句也很简单：</p><div class="language-"><pre><code>COMMIT [WORK]
</code></pre></div><p>COMMIT语句就代表提交一个事务，后边的WORK可有可无。</p><h3 id="手动中止事务" tabindex="-1">手动中止事务 <a class="header-anchor" href="#手动中止事务" aria-hidden="true">#</a></h3><p>如果我们写了几条语句之后发现上边的某条语句写错了，我们可以手动的使用下边这个语句来将数据库恢复到事务执行之前的样子：</p><div class="language-"><pre><code>ROLLBACK [WORK]
</code></pre></div><p>ROLLBACK语句就代表中止并回滚一个事务，后边的WORK可有可无类似的。</p><h3 id="自动提交" tabindex="-1">自动提交 <a class="header-anchor" href="#自动提交" aria-hidden="true">#</a></h3><p>MySQL中有一个系统变量autocommit：</p><div class="language-"><pre><code>mysql&gt; SHOW VARIABLES LIKE &#39;autocommit&#39;;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| autocommit    | ON    |
+---------------+-------+
1 row in set (0.01 sec)
</code></pre></div><p>可以看到它的默认值为ON，也就是说默认情况下，如果我们不显式的使用START TRANSACTION或者BEGIN语句开启一个事务，那么每一条语句都算是一个独立的事务，这种特性称之为事务的自动提交。</p><p>当然，如果我们想关闭这种自动提交的功能，可以使用下边两种方法之一：</p><ul><li>显式的的使用START TRANSACTION或者BEGIN语句开启一个事务。 这样在本次事务提交或者回滚前会暂时关闭掉自动提交的功能。</li><li>把系统变量autocommit的值设置为OFF，就像这样：<div class="language-"><pre><code>SET autocommit = OFF; 
</code></pre></div></li></ul><h3 id="保存点" tabindex="-1">保存点 <a class="header-anchor" href="#保存点" aria-hidden="true">#</a></h3><p>如果你开启了一个事务，并且已经敲了很多语句，忽然发现上一条语句有点问题，你只好使用ROLLBACK语句来让数据库状态恢复到事务执行之前的样子，然后一切从头再来，总有一种一夜回到解放前的感觉。所以设计数据库的大叔们提出了一个保存点（英文：savepoint）的概念，就是在事务对应的数据库语句中打几个点，我们在调用ROLLBACK语句时可以指定会滚到哪个点，而不是回到最初的原点。定义保存点的语法如下：</p><div class="language-"><pre><code>SAVEPOINT 保存点名称;
</code></pre></div><p>当我们想回滚到某个保存点时，可以使用下边这个语句（下边语句中的单词WORK和SAVEPOINT是可有可无的）：</p><div class="language-"><pre><code>ROLLBACK [WORK] TO [SAVEPOINT] 保存点名称;
</code></pre></div><p>如果我们想删除某个保存点，可以使用这个语句：</p><div class="language-"><pre><code>RELEASE SAVEPOINT 保存点名称;
</code></pre></div><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-hidden="true">#</a></h2><p><a href="https://juejin.cn/book/6844733769996304392/section/6844733770063609869?enter_from=course_center" target="_blank" rel="noopener noreferrer">https://juejin.cn/book/6844733769996304392/section/6844733770063609869?enter_from=course_center</a></p></div></div><footer class="page-footer" data-v-8fcebc32 data-v-b65b4b36><div class="edit" data-v-b65b4b36><div class="edit-link" data-v-b65b4b36 data-v-55695e90><!----></div></div><div class="updated" data-v-b65b4b36><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--><div class="site-footer"> Copyright © 2021-present <a class="vitepress">hassan</a><br> Powered by <a class="vitepress" target="_blank" href="//vitepress.vuejs.org/">VitePress</a></div><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"catalog_content.md\":\"d86ff705\",\"index.md\":\"c10b30fa\",\"page_2.md\":\"e6bb27dd\",\"page_3.md\":\"525e0d9e\",\"page_4.md\":\"d1ed67f6\",\"page_5.md\":\"11bcec30\",\"page_6.md\":\"0589eed0\",\"pages_about.md\":\"0c48d058\",\"pages_archives.md\":\"30483b77\",\"pages_tags.md\":\"28d7fc21\",\"posts_blog_github-action.md\":\"e50ed124\",\"posts_blog_vitepress-github.md\":\"35132ac7\",\"posts_contract_abi.md\":\"5362b7cd\",\"posts_contract_abstract_interface.md\":\"4e95508f\",\"posts_contract_call.md\":\"64629e48\",\"posts_contract_call_contract.md\":\"6ed55929\",\"posts_contract_constructor_modifer.md\":\"9e88c878\",\"posts_contract_create.md\":\"f074f6b8\",\"posts_contract_data_reference.md\":\"4b255b0f\",\"posts_contract_data_storage.md\":\"05e6a694\",\"posts_contract_delegatecall.md\":\"cc4a5038\",\"posts_contract_event.md\":\"4abc80bd\",\"posts_contract_exception.md\":\"719bceea\",\"posts_contract_fun_overloading.md\":\"1ef0df6b\",\"posts_contract_fun_return_val.md\":\"8bc49729\",\"posts_contract_fun_type.md\":\"08e7fecb\",\"posts_contract_import.md\":\"a2afb9a9\",\"posts_contract_inheritance.md\":\"37901dd1\",\"posts_contract_library.md\":\"c9a0cf76\",\"posts_contract_mapping.md\":\"d3ba9296\",\"posts_contract_receive_eth.md\":\"605ae6f8\",\"posts_contract_selector.md\":\"98f01400\",\"posts_contract_send_eth.md\":\"4326dca1\",\"posts_contract_value_type.md\":\"a2e59b2a\",\"posts_docker_accelerator.md\":\"36e08a0e\",\"posts_es_es_base_concept.md\":\"00283ad8\",\"posts_es_es_dsl_one.md\":\"eed4561b\",\"posts_es_es_dsl_three.md\":\"d2c0b379\",\"posts_es_es_dsl_two.md\":\"c122aa60\",\"posts_es_es_index.md\":\"77f18ef1\",\"posts_es_es_query_agg.md\":\"07a875c6\",\"posts_es_es_type.md\":\"63be964e\",\"posts_git_git-learn.md\":\"c0cdd15a\",\"posts_linux_linux_fork.md\":\"19ef5a41\",\"posts_linux_linux_pipe.md\":\"ee3cccf6\",\"posts_linux_linux_recv.md\":\"a4fa937f\",\"posts_mysql_groupby_orderby.md\":\"3ab7ad05\",\"posts_mysql_mysql_lock_one.md\":\"68bbaf9c\",\"posts_mysql_mysql_mvcc.md\":\"0ea92079\",\"posts_mysql_mysql_partition.md\":\"05199b35\",\"posts_mysql_mysql_transaction.md\":\"814564e1\",\"posts_network_tcp-model.md\":\"657d2eb0\",\"posts_network_tcp-three-shark.md\":\"3b87845d\",\"posts_network_tcp-time_wait.md\":\"7e827603\",\"posts_network_tpcip-one.md\":\"5c48ae81\",\"posts_personal_information.md\":\"82225e1d\",\"posts_personal_study.md\":\"db3bb716\",\"posts_personal_think-habit.md\":\"2d02c042\",\"posts_personal_think-object.md\":\"db4c9be6\",\"posts_personal_work-five.md\":\"efe4c215\",\"posts_tools_parallel-centos.md\":\"231dcb2a\"}")</script>
    <script type="module" async src="/assets/app.a5662684.js"></script>
    
  </body>
</html>